import random

from sklearn.naive_bayes import GaussianNB
from sklearn.model_selection import train_test_split
from sklearn import metrics
import numpy as np

class Individual:

    def __init__(self, size):
        self.fitness = 0
        self.score = 0
        self.size = size
        self.initial_features = round(size * 0.5)
        self.genes = self.generate_random_genes(size, self.initial_features)
        self.model = None

    @staticmethod
    def generate_random_genes(size, initial_features):
        genes = []
        for i in range(initial_features):
            genes.append(True)
        for i in range(size - initial_features):
            genes.append(False)
        np.random.shuffle(genes)

        return genes

    def get_fitness(self):
        return self.fitness

    def get_model(self):
        return self.model

    def calc_fitness(self, x_train, y_train):
        clf = GaussianNB()
        new_x_train, new_x_test, new_y_train, new_y_test = train_test_split(x_train, y_train)
        clf.fit(new_x_train.iloc[:, self.genes], new_y_train)
        y_pred = clf.predict(new_x_test.iloc[:, self.genes])
        self.fitness = metrics.accuracy_score(new_y_test, y_pred)
        self.model = clf

    # Midpoint
    # def crossover(self, mate):
    #     child = Individual(len(self.genes))
    #
    #     midpoint = len(self.genes) // 2
    #     child.genes = self.genes[:midpoint] + mate.genes[midpoint:]
    #
    #     return child

    # Uniform
    def crossover(self, mate):
        child = Individual(len(self.genes))

        for i in range(len(child.genes)):
            if random.random() <= 0.5:
                child.genes[i] = self.genes[i]
            else:
                child.genes[i] = mate.genes[i]

        return child

    # K sub
    # def crossover(self, mate):
    #     k = 3
    #     child = Individual(len(self.genes))
    #
    #     for i in range(len(child.genes)):
    #         if (i // k) % 2 == 0:
    #             child.genes[i] = self.genes[i]
    #         else:
    #             child.gene[i] = mate.genes[i]

    def mutate(self, mutation_rate):
        for elem in enumerate(self.genes):
            if random.uniform(0, 1) < mutation_rate:
                self.genes[elem[0]] = not self.genes[elem[0]]

    def __repr__(self):
        features = []
        num = 0
        for i in range(self.size):
            if self.genes[i]:
                features.append(str(i))
                num += 1
        return "Number of features: {} Features: ".format(num) + ' '.join(features) + " -> fitness: " + str(self.fitness)